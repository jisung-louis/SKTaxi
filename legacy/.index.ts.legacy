import * as admin from 'firebase-admin';
import { onDocumentCreated, onDocumentDeleted } from 'firebase-functions/v2/firestore';
import { onRequest } from 'firebase-functions/v2/https';
import { onSchedule } from 'firebase-functions/v2/scheduler';
import { setGlobalOptions } from 'firebase-functions/v2/options';
const Parser = require('rss-parser');

// SKTaxi: ëª¨ë“  í•¨ìˆ˜ ê¸°ë³¸ ë¦¬ì „ì„ Firestore ë¦¬ì „ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •
setGlobalOptions({ region: 'asia-northeast3' });

admin.initializeApp();
const db = admin.firestore();
const fcm = admin.messaging();

// SKTaxi: SSL ì„¤ì • (í•™êµ ì‚¬ì´íŠ¸ìš©) //ìœ„í—˜í•¨ ê³ ì³ì•¼í•¨
process.env["NODE_TLS_REJECT_UNAUTHORIZED"] = "0";

// SKTaxi: RSS íŒŒì„œ ì„¤ì •
const parser = new Parser({
  customFields: {
    item: ['description', 'content:encoded']
  },
  headers: {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
  },
  rejectUnauthorized: false
});

// SKTaxi: ê³µì§€ì‚¬í•­ ì¹´í…Œê³ ë¦¬ë³„ RSS ì„¤ì •
const NOTICE_CATEGORIES = {
  'ìƒˆì†Œì‹': 97,
  'í•™ì‚¬': 96,
  'í•™ìƒ': 116,
  'ì¥í•™/ë“±ë¡/í•™ìê¸ˆ': 95,
  'ì…í•™': 94,
  'ì·¨ì—…/ì§„ë¡œê°œë°œ/ì°½ì—…': 93,
  'ê³µëª¨/í–‰ì‚¬': 90,
  'êµìœ¡/ê¸€ë¡œë²Œ': 89,
  'ì¼ë°˜': 87,
  'ì…ì°°êµ¬ë§¤ì •ë³´': 86,
  'ì‚¬íšŒë´‰ì‚¬ì„¼í„°': 84,
  'ì¥ì• í•™ìƒì§€ì›ì„¼í„°': 83,
  'ìƒí™œê´€': 82,
  'ë¹„êµê³¼': 80
} as const;

const RSS_BASE_URL = 'https://www.sungkyul.ac.kr/bbs/skukr';

export const onJoinRequestCreate = onDocumentCreated('joinRequests/{requestId}', async (event) => {
  const snap = event.data;
  if (!snap) return;
  const req = snap.data() as any;
  const leaderId = req?.leaderId as string | undefined;
  if (!leaderId) return;

  const userDoc = await db.doc(`users/${leaderId}`).get();
  const tokens: string[] = (userDoc.get('fcmTokens') || []) as string[];
  if (!tokens.length) return;

  const message = {
    tokens,
    notification: {
      title: 'ë™ìŠ¹ ìš”ì²­ì´ ë„ì°©í–ˆì–´ìš”',
      body: 'ì•±ì—ì„œ í™•ì¸í•˜ê³  ìˆ˜ë½/ê±°ì ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.',
    },
    data: {
      type: 'join_request',
      partyId: String(req?.partyId || ''),
      requestId: String(event.params.requestId || ''),
      requesterId: String(req?.requesterId || ''),
    },
    apns: { payload: { aps: { sound: 'default' } } },
    android: { priority: 'high' as const },
  };

  const resp = await fcm.sendEachForMulticast(message as any);
  // SKTaxi: ì‹¤íŒ¨í•œ í† í° ì •ë¦¬
  const failedTokens: string[] = [];
  resp.responses.forEach((r, idx) => {
    if (!r.success) failedTokens.push((message as any).tokens[idx]);
  });
  if (failedTokens.length) {
    await db.runTransaction(async (tx) => {
      const ref = db.doc(`users/${leaderId}`);
      const snapUser = await tx.get(ref);
      const cur: string[] = (snapUser.get('fcmTokens') || []) as string[];
      const next = cur.filter((t) => !failedTokens.includes(t));
      tx.update(ref, { fcmTokens: next });
    });
  }
});

// SKTaxi: íŒŒí‹° ì‚­ì œ ì‹œ ë©¤ë²„ë“¤ì—ê²Œ ì•Œë¦¼ ì „ì†¡
export const onPartyDelete = onDocumentDeleted('parties/{partyId}', async (event) => {
  const snap = event.data;
  if (!snap) return;
  const partyData = snap.data() as any;
  const members = partyData?.members as string[] | undefined;
  const leaderId = partyData?.leaderId as string | undefined;
  
  if (!members || !Array.isArray(members) || members.length <= 1) return; // ë¦¬ë”ë§Œ ìˆìœ¼ë©´ ì•Œë¦¼ ë¶ˆí•„ìš”

  // SKTaxi: ë¦¬ë”ë¥¼ ì œì™¸í•œ ë©¤ë²„ë“¤ì—ê²Œë§Œ ì•Œë¦¼ ì „ì†¡
  const memberIds = members.filter((memberId: string) => memberId !== leaderId);
  if (memberIds.length === 0) return;

  // SKTaxi: ë©¤ë²„ë“¤ì˜ FCM í† í° ìˆ˜ì§‘
  const tokens: string[] = [];
  for (const memberId of memberIds) {
    try {
      const userDoc = await db.doc(`users/${memberId}`).get();
      const userTokens = (userDoc.get('fcmTokens') || []) as string[];
      tokens.push(...userTokens);
    } catch (error) {
      console.error(`Error getting tokens for user ${memberId}:`, error);
    }
  }

  if (tokens.length === 0) return;

  const message = {
    tokens,
    notification: {
      title: 'íŒŒí‹°ê°€ í•´ì²´ë˜ì—ˆì–´ìš”',
      body: 'ë¦¬ë”ê°€ íŒŒí‹°ë¥¼ í•´ì²´í–ˆìŠµë‹ˆë‹¤.',
    },
    data: {
      type: 'party_deleted',
      partyId: String(event.params.partyId || ''),
    },
    apns: { payload: { aps: { sound: 'default' } } },
    android: { priority: 'high' as const },
  };

  const resp2 = await fcm.sendEachForMulticast(message as any);
  // SKTaxi: ì‹¤íŒ¨í•œ í† í° ì •ë¦¬ (ë©¤ë²„ ì „ì›)
  const deadTokens: string[] = [];
  resp2.responses.forEach((r, idx) => {
    if (!r.success) deadTokens.push((message as any).tokens[idx]);
  });
  if (deadTokens.length) {
    // ê° ë©¤ë²„ ë¬¸ì„œì—ì„œ ì£½ì€ í† í° ì œê±°
    await Promise.all(memberIds.map(async (uid) => {
      try {
        const userRef = db.doc(`users/${uid}`);
        const userSnap = await userRef.get();
        const cur: string[] = (userSnap.get('fcmTokens') || []) as string[];
        const next = cur.filter((t) => !deadTokens.includes(t));
        if (next.length !== cur.length) await userRef.update({ fcmTokens: next });
      } catch {}
    }));
  }
});

// SKTaxi: ë‹¨ì¼ ì¹´í…Œê³ ë¦¬ RSS ì²˜ë¦¬
async function processSingleCategory(category: string, categoryId: number, rowCount: number) {
  const rssUrl = `${RSS_BASE_URL}/${categoryId}/rssList.do?row=${rowCount}`;
  
  try {
    const feed = await parser.parseURL(rssUrl);
    console.log(`ğŸ“Š ${category} RSS íŒŒì‹± ì„±ê³µ: ${feed.items.length}ê°œ ì•„ì´í…œ`);
    
    return feed.items.map((item: any, index: number) => {
      // ìƒëŒ€ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
      const fullLink = item.link?.startsWith('http') 
        ? item.link 
        : `https://www.sungkyul.ac.kr${item.link}`;
      
      // SKTaxi: Firestore ë¬¸ì„œ IDëŠ” ì¹´í…Œê³ ë¦¬ì™€ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í¬í•¨
      const docId = `rss_${categoryId}_${Date.now()}_${index}`;
      
      // SKTaxi: guidëŠ” ë³„ë„ í•„ë“œë¡œ ì €ì¥
      const cleanGuid = (item.guid || fullLink || `rss_${categoryId}_${Date.now()}_${index}`)
        .replace(/[^a-zA-Z0-9_-]/g, '_') // íŠ¹ìˆ˜ë¬¸ìë¥¼ _ë¡œ ë³€í™˜
        .replace(/_+/g, '_') // ì—°ì†ëœ _ë¥¼ í•˜ë‚˜ë¡œ ë³€í™˜
        .substring(0, 100); // ê¸¸ì´ ì œí•œ
      
      return {
        id: docId, // SKTaxi: Firestore ë¬¸ì„œ IDì™€ ë™ì¼
        title: item.title || '',
        content: item.contentSnippet || item.content || '',
        link: fullLink,
        date: item.pubDate || '',
        category: category, // SKTaxi: ì‹¤ì œ ì¹´í…Œê³ ë¦¬ëª… ì‚¬ìš©
        createdAt: new Date().toISOString(),
        author: 'ì„±ê²°ëŒ€í•™êµ',
        guid: cleanGuid, // SKTaxi: ë³„ë„ í•„ë“œë¡œ ì €ì¥
        source: 'RSS'
      };
    });
  } catch (error) {
    console.error(`âŒ ${category} RSS ì²˜ë¦¬ ì‹¤íŒ¨:`, error);
    return []; // ì‹¤íŒ¨í•œ ì¹´í…Œê³ ë¦¬ëŠ” ë¹ˆ ë°°ì—´ ë°˜í™˜
  }
}

// SKTaxi: ê³µì§€ì‚¬í•­ ì²˜ë¦¬ ê³µí†µ ë¡œì§ (ëª¨ë“  ì¹´í…Œê³ ë¦¬)
async function processSchoolNotices(rowCount: number = 2000) {
  console.log(`ğŸ” í•™êµ ê³µì§€ì‚¬í•­ RSS ê°€ì ¸ì˜¤ê¸° ì‹œì‘... (${rowCount}ê°œ)`);
  
  const allNotices: any[] = [];
  const categoryResults: {[key: string]: number} = {};
  
  // SKTaxi: ëª¨ë“  ì¹´í…Œê³ ë¦¬ ë³‘ë ¬ ì²˜ë¦¬
  const categoryPromises = Object.entries(NOTICE_CATEGORIES).map(async ([category, categoryId]) => {
    const notices = await processSingleCategory(category, categoryId, rowCount);
    categoryResults[category] = notices.length;
    return notices;
  });
  
  const categoryNoticesArrays = await Promise.all(categoryPromises);
  
  // SKTaxi: ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ ê³µì§€ì‚¬í•­ì„ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í•©ì¹˜ê¸°
  categoryNoticesArrays.forEach(notices => {
    allNotices.push(...notices);
  });
  
  console.log(`ğŸ“Š ì „ì²´ RSS íŒŒì‹± ì™„ë£Œ: ${allNotices.length}ê°œ ì•„ì´í…œ`);
  console.log(`ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ê²°ê³¼:`, categoryResults);
  
  // SKTaxi: ê¸°ì¡´ ê³µì§€ì‚¬í•­ê³¼ ë¹„êµí•˜ì—¬ ìƒˆ ê³µì§€ì‚¬í•­ë§Œ ì¶”ê°€
  const batch = db.batch();
  const collectionRef = db.collection('notices');
  
  // ê¸°ì¡´ ê³µì§€ì‚¬í•­ ID ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  const existingNoticesSnapshot = await collectionRef.get();
  const existingIds = new Set(existingNoticesSnapshot.docs.map(doc => doc.id));
  
  let newNoticesCount = 0;
  let updatedNoticesCount = 0;
  
  for (const notice of allNotices) {
    const docRef = collectionRef.doc(notice.id); // SKTaxi: idë¥¼ ë¬¸ì„œ IDë¡œ ì‚¬ìš©
    
    if (existingIds.has(notice.id)) {
      // ê¸°ì¡´ ê³µì§€ì‚¬í•­ ì—…ë°ì´íŠ¸ (ë‚´ìš© ë³€ê²½ ê°€ëŠ¥)
      batch.set(docRef, notice, { merge: true });
      updatedNoticesCount++;
    } else {
      // ìƒˆ ê³µì§€ì‚¬í•­ ì¶”ê°€
      batch.set(docRef, notice);
      newNoticesCount++;
    }
  }
  
  await batch.commit();
  
  console.log(`ğŸ“Š ì²˜ë¦¬ ê²°ê³¼: ìƒˆ ê³µì§€ì‚¬í•­ ${newNoticesCount}ê°œ, ì—…ë°ì´íŠ¸ ${updatedNoticesCount}ê°œ`);
  console.log(`âœ… ${allNotices.length}ê°œ ê³µì§€ì‚¬í•­ ì €ì¥ ì™„ë£Œ`);
  
  return {
    totalCount: allNotices.length,
    newCount: newNoticesCount,
    updatedCount: updatedNoticesCount,
    categoryResults: categoryResults
  };
}

// SKTaxi: ì´ˆê¸° DB ì„¸íŒ…ìš© - ëª¨ë“  ê³µì§€ì‚¬í•­ í•œ ë²ˆì— ê°€ì ¸ì˜¤ê¸° (ê°œë°œìë§Œ ì‚¬ìš©)
export const fetchSchoolNotices = onRequest(async (req, res) => {
  try {
    const result = await processSchoolNotices(2000);
    
    res.json({ 
      success: true, 
      count: result.totalCount,
      newCount: result.newCount,
      updatedCount: result.updatedCount,
      categoryResults: result.categoryResults,
      message: 'ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
    
  } catch (error) {
    console.error('âŒ RSS ì²˜ë¦¬ ì‹¤íŒ¨:', error);
    res.status(500).json({ 
      success: false, 
      error: (error as Error).message 
    });
  }
});

// SKTaxi: 30ë¶„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ìƒˆ ê³µì§€ì‚¬í•­ë§Œ ì¶”ê°€ (ì‚¬ìš©ì ê²½í—˜ì— ì˜í–¥ ì—†ìŒ)
export const scheduledRSSFetch = onSchedule({
  schedule: '*/30 * * * *',
  timeZone: 'Asia/Seoul'
}, async (event) => {
  try {
    console.log('â° ìŠ¤ì¼€ì¤„ëœ RSS ê°€ì ¸ì˜¤ê¸° ì‹œì‘...');
    
    const result = await processSchoolNotices(100); // SKTaxi: 30ë¶„ë§ˆë‹¤ ì‹¤í–‰ë˜ë¯€ë¡œ 100ê°œë©´ ì¶©ë¶„
    
    console.log(`ğŸ“Š ìŠ¤ì¼€ì¤„ ì²˜ë¦¬ ê²°ê³¼: ìƒˆ ê³µì§€ì‚¬í•­ ${result.newCount}ê°œ, ì—…ë°ì´íŠ¸ ${result.updatedCount}ê°œ`);
    console.log(`âœ… ìŠ¤ì¼€ì¤„ëœ RSS ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: ${result.totalCount}ê°œ`);
    
  } catch (error) {
    console.error('âŒ ìŠ¤ì¼€ì¤„ëœ RSS ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
  }
});
